# 用户手册

## 目录

* 我是用户
  - 我该如何启动 bpm？
  - 注意事项
  - 各命令参数解释
* 我是服务器管理员
  - 启动服务器
  - 关闭服务器
  - 服务器维护
  - 服务器同步

## 我是用户

bpm是个命令行程序，很明显，它根本不是为计算机小白准备的，请确保你的年龄大于12岁，然后再考虑阅读此手册。

### 我该如何启动 bpm？

如果你只会通过双击程序来启动程序，并且拒绝学习任何新方法用于启动程序，建议立即关闭这个文档并删除所有bpm内容。

下载安装包后，务必完全解压到一个空白文件夹中。

首先使用搜索功能（Windows 7 在开始菜单下方，Windows 10 请使用 Cortana）搜索 PowerShell ，找到后右键-以管理员身份执行。

然后前往你放有 bpm.exe 的文件夹，复制这个文件夹的地址，它看起来可能比较像`D:\MySoftware\bpm`，我们把这堆文本记为xxx。

然后在你刚刚打开的 PowerShell 窗口中输入指令`cd xxx`，其中 xxx 是你刚刚复制的文件夹地址，然后回车

然后输入`bpm help`并回车，如果能输出一串帮助文档，则表明没有问题了。

另外，在上述过程中，可能会有一个要求您输入一个地址的步骤，请参见注意事项自行决策。

此后，如果需要运行其他命令，只需要输入`bpm 命令名 参数1 参数2 ...`即可

### 注意事项

* 第一次启动 bpm 会自动建立一系列文件夹，在任何时候都请勿删除这些文件夹
* 执行`bpm update`之后会在本地得到一个`package.db`，也请在任何时候都不要删除这个文件
* bpm 不会自动识别您已安装的 Ballance。相反，我们反而建议您在一台没有安装 Ballance 的计算机上先安装 bpm，或者是卸载现在安装过的 Ballance 转而安装 bpm，然后由 bpm 安装 Ballance，这样可使 bpm 得以管理一切，bpm 和会在启动的时候要求您输入一个存在文件夹的路径，bpm 会将所有游戏文件存储在那。如果您坚持使用您自己安装的 Ballance，也是可以的，您只需要在开头路径输入环节输入您的 Ballance 根目录即可，但请务必确保您的 Ballance 是英文原版，没有任何修改，否则任何命令执行时的错误，我都不会给予帮助支持。使用 bpm 安装 Ballance 的命令是`bpm install ballance@v1.13`
* 默认语言为英语，使用`bpm config Language zh-cn`设置中文
* 默认连接到 Ballance 资源总服务器，如果需要连接其它服务器，使用`bpm config Sources IP:Port`进行设置
* 第一次启动后，需要执行`bpm update`更新包数据库后才能执行大部分操作

### 各命令参数解释

* list 无参数：列出当前安装的包信息
* update 无参数：与远程服务器同步包数据库
* show 包名：输出指定包的详细信息
* search 单词：从数据库中搜索与所提供单词有关的包，会搜索包名与包别名
* install 包名：安装指定包
* remove 包名：移除指定包
* deploy 包名 参数：配置包，用于地图/背景的配置，地图指定关卡编号，其余的指定背景编号或者所适用的关卡均可
* config 设置名 新值：设置相关设置，不指定任何参数列出所有设置，仅指定设置名将列出指定设置的当前值

## 我是服务器管理员

你首先需要一台 Windows 服务器，目前 BPMServer 不支持在非 Windows 服务器上运行。

BPMServer 是一个 C/S 应用，使用 Tcp 流模式传输数据。因此你无需配置 Web 服务，只需要一个空闲端口，BPMServer 就能跑起来。

### 启动服务器

下载可执行文件后，您可以直接运行 BPMServer.exe，服务端程序将会自动创建2个必须目录：package 与 dependency，并初始化一个空的数据库 package.db。并自动生成一个默认配置文件 config.cfg，用于决定监听端口：

```json
{
    "IPv4Port": "6161",
    "IPv6Port": "8181"
}
```

如果您不想使用这些端口，您可以在运行 BPMServer.exe 之前提前配置好这个文件。

此外，服务器会自动启动一个守护程序 BPMSDaemon.exe，用于保护服务器的持续运行。如果服务器崩溃了，Daemon 会在至多 30s 内重启服务器，您可以通过重新编译 Daemon 程序来修改这个超时时间。

### 关闭服务器

在 BPMServer.exe 窗口中按下 Tab 键以打开命令输入栏，输入 exit 将会立即拒绝任何新的连接请求并等待当前连接请求结束数据传输后退出程序。

当遇到紧急情况时，例如有人攻击了你的服务器，或者有人恶意大量获取你的数据导致服务器无法正常响应相关服务。可以输入 crash 来立即结束程序。此操作将会在结束 Daemon 后立即关闭程序，不等待任何资源的释放。

请务必使用 BPMServer.exe 窗口来关闭服务器，或者使用脚本同时关闭 BPMServer.exe 与 BPMSDaemon.exe，否则，只要有一方存在，另一方都将在不久后重启。

### 服务器维护

BPMServer 使用冷维护来进行数据维护。

运行 BPMSMaintenance.exe 即可打开服务器维护程序。输入相关命令维护服务器。（您可以选择在运行 BPMServer.exe 之前就维护，维护程序同样会帮你创建 2 个必须文件夹以及一个空的数据库文件）

命令列表：

* addpkg NAME AKA TYPE VERSION DESCRIPTION
* addver NAME VERSION
* delpkg NAME
* delver NAME VERSION

注意事项：

* 添加包/版本时，需要将匹配的 zip 文件命名为 new_package.zip，将匹配的 json 文件命名为 new_package.json，并都置于 BPMSMaintenance.exe 所在目录下，然后再执行命令
* 如果参数中需要空格，例如 description 中需要输入空格，可用`"`将参数框起来，否则会判定参数个数错误
* 如果参数为空，例如 aka 不存在，输入`""`即可
* delpkg 不会检测存在的版本个数，会悉数删除

### 服务器同步

同步？你在说啥？这破游戏流量那么少还需要分布式服务器？还需要同步？

好吧，如果流量变多的话我会搞个同步命令的。与互联网上指定计算机上的另一个 BPMServer 进行同步